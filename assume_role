#!/usr/bin/env bash


for ARGUMENT in "$@"
do
    KEY=$(echo $ARGUMENT | cut -f1 -d=)
    VALUE=$(echo $ARGUMENT | cut -f2 -d=)

    case "$KEY" in
            -arn| --role-arn) arn=${VALUE} ;;
            -unset) unset=${VALUE} ;;
            -h | --help | ?) help ;;
            *)
    esac
done


#if [ $1 = "unset" ]; then
#
#  if [[ -z "${ORIGINAL_AWS_ACCESS_KEY_ID}" ]]; then
#    echo "ORIGINAL_AWS_ACCESS_KEY_ID does not exists"
#    exit 1
#  fi
#
#  unset AWS_ACCESS_KEY_ID
#  unset AWS_SECRET_ACCESS_KEY
#  unset AWS_SESSION_TOKEN
#  unset AWS_EXPIRATION
#
#  export AWS_ACCESS_KEY_ID=${ORIGINAL_AWS_ACCESS_KEY_ID}
#  export AWS_SECRET_ACCESS_KEY=${ORIGINAL_AWS_SECRET_ACCESS_KEY}
#
#  unset ORIGINAL_AWS_ACCESS_KEY_ID
#  unset ORIGINAL_AWS_SECRET_ACCESS_KEY
#  echo "-------Original------"
#  aws s3 ls
#fi


ROLE_SESSION_NAME="ROLE_SESSION_NAME_"`date +%s`
CMD="aws sts assume-role --role-arn ${arn} --role-session-name ${ROLE_SESSION_NAME} --duration-seconds 900 --output=json"
echo $CMD
CREDENTIALS=$(aws sts assume-role --role-arn ${arn} --role-session-name ${ROLE_SESSION_NAME} --duration-seconds 900 --output=json) # `aws sts assume-role --role-arn "${2}" --role-session-name ${ROLE_NAME} --duration-seconds 900 --output=json`
echo $CREDENTIALS
export ORIGINAL_AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
export ORIGINAL_AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}

export AWS_DEFAULT_REGION=us-east-1
export AWS_ACCESS_KEY_ID=`echo ${CREDENTIALS} | jq -r '.Credentials.AccessKeyId'`
export AWS_SECRET_ACCESS_KEY=`echo ${CREDENTIALS} | jq -r '.Credentials.SecretAccessKey'`
export AWS_SESSION_TOKEN=`echo ${CREDENTIALS} | jq -r '.Credentials.SessionToken'`
export AWS_EXPIRATION=`echo ${CREDENTIALS} | jq -r '.Credentials.Expiration'`

echo "-------Run as Assumed Role ------"
aws s3 ls
echo "Variable ORIGINAL_AWS_ACCESS_KEY_ID is saved in memory"



